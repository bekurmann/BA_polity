stages:
    - build-docker
    - test
    - deploy

build-backend-django:
    tags:
        - build-docker
    stage: build-docker
    image: docker:latest
    services:
        - docker:dind
    script:
        - cd frontend
        - docker build -f Dockerfile.prod -t $CI_REGISTRY_IMAGE/backend-django:latest .
        - docker tag $CI_REGISTRY_IMAGE/backend-django:latest $CI_REGISTRY_IMAGE/backend-django:$CI_COMMIT_REF_NAME
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - docker push $CI_REGISTRY_IMAGE/backend-django:$CI_COMMIT_REF_NAME

build-frontend-nuxt:
    tags:
        - build-docker
    stage: build-docker
    image: docker:latest
    services:
        - docker:dind
    script:
        - cd backend
        - docker build -f Dockerfile.prod -t $CI_REGISTRY_IMAGE/frontend-nuxt:latest .
        - docker tag $CI_REGISTRY_IMAGE/frontend-nuxt:latest $CI_REGISTRY_IMAGE/frontend-nuxt:$CI_COMMIT_REF_NAME
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - docker push $CI_REGISTRY_IMAGE/frontend-nuxt:$CI_COMMIT_REF_NAME

build-nginx:
    tags:
        - build-docker
    stage: build-docker
    image: docker:latest
    services:
        - docker:dind
    script:
        - cd nginx
        - docker build -f Dockerfile -t $CI_REGISTRY_IMAGE/nginx:latest .
        - docker tag $CI_REGISTRY_IMAGE/nginx:latest $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_REF_NAME
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - docker push $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_REF_NAME
    only: 
        changes:
            - nginx/*